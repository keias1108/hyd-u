<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hydrothermal Vent Simulation - WebGPU</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  </head>
  <body>
    <!-- 좌측 사이드바: 컨트롤 패널 -->
    <div id="controls-sidebar">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <h1>Hydrothermal Vent</h1>
        <button id="toggleSidebarBtn" class="sidebar-toggle-btn" title="Toggle Sidebar">◀</button>
      </div>
      <p class="subtitle">WebGPU R-O Field Model</p>

      <!-- 시뮬레이션 컨트롤 -->
      <div class="section">
        <div class="controls-row">
          <button id="startButton" class="btn btn-primary">Pause</button>
          <button id="resetButton" class="btn btn-secondary">Reset</button>
        </div>
      </div>

      <!-- 파라미터 컨트롤 (동적 생성) -->
      <div id="controls"></div>
    </div>

    <!-- 우측 메인: 캔버스 전체 화면 -->
    <div id="canvas-container">
      <canvas id="renderCanvas" width="800" height="800"></canvas>

      <!-- Entity selection overlay (marker + tether) -->
      <svg id="selectionOverlay" class="selection-overlay" viewBox="0 0 800 800" preserveAspectRatio="none">
        <line id="selectionTether" x1="0" y1="0" x2="0" y2="0" class="selection-tether hidden"></line>
        <circle id="selectionMarker" cx="0" cy="0" r="6" class="selection-marker hidden"></circle>
      </svg>

      <!-- 캔버스 오버레이: 우측 상단 정보 -->
      <div class="canvas-overlay">
        <div class="overlay-item">
          <span class="overlay-label">FPS</span>
          <span class="overlay-value" id="fps-counter">--</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">Steps/sec</span>
          <span class="overlay-value" id="steps-per-second">--</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">O avg</span>
          <span class="overlay-value" id="o-avg">0.800</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">R total</span>
          <span class="overlay-value" id="r-total">0.0</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">H avg</span>
          <span class="overlay-value" id="h-avg">0.000</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">M total</span>
          <span class="overlay-value" id="m-total">0.0</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">B total</span>
          <span class="overlay-value" id="b-total">0.0</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">P total</span>
          <span class="overlay-value" id="p-total">0.0</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">P2 total</span>
          <span class="overlay-value" id="p2-total">0.0</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">P invalid</span>
          <span class="overlay-value" id="p-invalid">0</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">P2 invalid</span>
          <span class="overlay-value" id="p2-invalid">0</span>
        </div>
      </div>

      <!-- 단축키 힌트: 좌측 하단 -->
      <div class="shortcuts-hint">
        <kbd>Space</kbd> Pause/Resume &nbsp; <kbd>Alt+S</kbd> Save JSON &nbsp; <kbd>Alt+Z</kbd> Reset
      </div>

      <!-- Entity inspection modal -->
      <div id="entityModal" class="entity-modal hidden">
        <div class="entity-modal-header">
          <span id="entityModalTitle" class="entity-modal-title">Entity</span>
          <button id="closeEntityModal" class="entity-modal-close">×</button>
        </div>
        <div class="entity-modal-body">
          <div class="entity-kv"><span>Type</span><span id="entityType">-</span></div>
          <div class="entity-kv"><span>Index</span><span id="entityIndex">-</span></div>
          <div class="entity-kv"><span>Pos</span><span id="entityPos">-</span></div>
          <div class="entity-kv"><span>Vel</span><span id="entityVel">-</span></div>
          <div class="entity-kv"><span>Energy</span><span id="entityEnergy">-</span></div>
          <div class="entity-kv"><span>State</span><span id="entityState">-</span></div>
          <div class="entity-kv"><span>Age</span><span id="entityAge">-</span></div>
        </div>
        <div class="entity-modal-resize-handle"></div>
      </div>
    </div>

    <!-- WebGPU 미지원 에러 메시지 -->
    <div id="error-message" class="hidden">
      <h2>WebGPU Not Available</h2>
      <p>
        This simulation requires WebGPU support. Please use a browser that
        supports WebGPU (Chrome 113+, Edge 113+).
      </p>
    </div>

    <!-- Floating Chart Modal -->
    <div id="chartModal" class="chart-modal hidden">
      <div class="chart-modal-header">
        <span class="chart-modal-title">Statistics Chart</span>
        <button id="closeChartModal" class="chart-modal-close">×</button>
      </div>
      <div class="chart-modal-body">
        <canvas id="floatingStatsChart"></canvas>
      </div>
      <div class="chart-modal-resize-handle"></div>
    </div>

    <!-- Batch Run Modal -->
    <div id="batchModal" class="batch-modal hidden">
      <div class="batch-modal-header">
        <span class="batch-modal-title">Batch Run</span>
        <button id="closeBatchModal" class="batch-modal-close">×</button>
      </div>
      <div class="batch-modal-body">
        <div class="batch-controls">
          <label class="batch-label">
            Steps
            <input id="batchSteps" type="number" min="1" step="1000" value="200000" class="batch-input" />
          </label>
          <label class="batch-label">
            Sample Every (steps)
            <input id="batchSampleEvery" type="number" min="1" step="10" value="1000" class="batch-input" />
          </label>
          <div class="batch-buttons">
            <button id="batchRunBtn" class="btn btn-primary">Run</button>
            <button id="batchStopBtn" class="btn btn-secondary" disabled>Stop</button>
            <button id="batchResetZoomBtn" class="btn btn-secondary">Reset Zoom</button>
          </div>
          <div class="batch-progress-row">
            <div class="batch-progress">
              <div id="batchProgressBar" class="batch-progress-bar"></div>
            </div>
            <div class="batch-progress-text">
              <span id="batchProgressText">Idle</span>
            </div>
          </div>
        </div>
        <div class="batch-chart">
          <canvas id="batchChart"></canvas>
        </div>
      </div>
      <div class="batch-modal-resize-handle"></div>
    </div>

    <script type="module" src="js/main.js"></script>
  </body>
</html>
